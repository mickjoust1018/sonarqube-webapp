# SonarQube WebApp 系统架构文档

## 1. 项目概述

SonarQube WebApp 是 SonarQube 代码质量分析平台的前端应用，采用现代化的 React 技术栈构建。本项目是一个基于 Nx 的 monorepo 工作区，使用 TypeScript、React、Vite 等现代前端技术。

### 1.1 基本信息
- **项目名称**: sonarqube-webapp
- **许可证**: LGPL-3.0
- **包管理器**: Yarn 4.10.3
- **Node 版本**: >=20.19.1 <21 || >=22.15 <23.12
- **构建工具**: Vite 7.1.12
- **框架**: React 18.3.1
- **路由**: React Router DOM 6.30.1

### 1.2 项目结构
```
sonarqube-webapp/
├── apps/                    # 应用程序目录
│   └── sq-server/          # SonarQube Server 前端应用
├── libs/                    # 共享库目录
│   ├── shared/             # 跨应用共享库（SQ-Server 和 SQ-Cloud）
│   ├── sq-server-commons/  # SQ-Server 专用共享库
│   ├── sq-server-addons/   # SQ-Server 插件扩展
│   └── feature-rules/      # 规则功能模块
├── tools/                   # 工具目录
│   ├── nx-automation/      # Nx 自动化工具
│   └── scan-components/    # 组件扫描工具
├── config/                  # 配置文件目录
├── eslint-local-rules/     # 本地 ESLint 规则
└── @types/                  # TypeScript 类型定义
```

## 2. 系统架构

### 2.1 整体架构

本项目采用 **Monorepo 架构**，基于 **Nx** 工作区管理，主要特点：

1. **模块化设计**: 将代码组织为多个独立的库和应用
2. **代码复用**: 通过共享库（shared、sq-server-commons）实现代码复用
3. **依赖管理**: 使用 TypeScript 路径别名和 Nx 的依赖图管理
4. **构建优化**: 使用 Vite 进行快速构建和开发

### 2.2 架构层次

```
┌─────────────────────────────────────────┐
│          Application Layer              │
│         (apps/sq-server)                │
│  - 路由配置                              │
│  - 页面组件                              │
│  - 应用入口                              │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│        Commons Library Layer            │
│     (libs/sq-server-commons)            │
│  - API 客户端                            │
│  - React Query 查询                      │
│  - 业务组件                              │
│  - 设计系统                              │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         Shared Library Layer            │
│          (libs/shared)                  │
│  - 通用工具函数                          │
│  - 基础组件                              │
│  - 类型定义                              │
│  - 上下文提供者                          │
└─────────────────────────────────────────┘
```

### 2.3 技术栈

#### 核心框架
- **React 18.3.1**: UI 框架
- **TypeScript 5.9.3**: 类型系统
- **React Router DOM 6.30.1**: 路由管理

#### 状态管理
- **@tanstack/react-query 5.56.2**: 服务端状态管理和数据获取
- **React Context API**: 客户端状态管理

#### UI 库和样式
- **@sonarsource/echoes-react 1.6.0**: 设计系统组件库（新）
- **@emotion/react 11.14.0**: CSS-in-JS 样式方案
- **Tailwind CSS 3.4.17**: 实用优先的 CSS 框架
- **twin.macro 3.4.1**: Tailwind + Emotion 集成

#### 构建工具
- **Vite 7.1.12**: 构建工具和开发服务器
- **@nx/vite**: Nx 的 Vite 插件
- **@vitejs/plugin-legacy**: 浏览器兼容性支持

#### 测试框架
- **Jest 30.0.5**: 测试框架
- **@testing-library/react 16.3.0**: React 组件测试
- **@testing-library/jest-dom**: DOM 断言库

#### 其他重要依赖
- **axios 1.12.0**: HTTP 客户端
- **react-intl 6.8.9**: 国际化
- **formik 2.4.6**: 表单管理
- **date-fns 4.1.0**: 日期处理
- **d3-***: 数据可视化库
- **highlight.js**: 代码高亮

## 3. 功能模块

### 3.1 应用模块（apps/sq-server/src/main/js/apps）

应用采用**功能模块化**的组织方式，每个功能模块包含：
- `routes.tsx`: 路由配置
- `components/`: 组件目录
- `*.tsx`: 主应用组件
- `utils.ts`: 工具函数

#### 主要功能模块

1. **账户管理 (account)**
   - 用户账户设置
   - 通知管理
   - 个人资料
   - 安全设置

2. **问题管理 (issues)**
   - 问题列表和搜索
   - 问题详情
   - 问题操作（分配、解决等）
   - 问题侧边栏

3. **代码查看 (code)**
   - 源代码查看器
   - 代码高亮
   - 代码覆盖率显示

4. **编码规则 (coding-rules)**
   - 规则列表
   - 规则详情
   - 规则激活/停用
   - 规则模板管理

5. **组件度量 (component-measures)**
   - 代码度量指标
   - 度量钻取
   - 度量侧边栏

6. **项目概览 (overview)**
   - 项目仪表板
   - 分支管理
   - 项目活动

7. **质量门 (quality-gates)**
   - 质量门配置
   - 质量门条件设置
   - 质量门状态

8. **质量配置 (quality-profiles)**
   - 质量配置管理
   - 规则激活
   - 配置比较

9. **安全热点 (security-hotspots)**
   - 安全热点列表
   - 安全热点审查
   - 安全标准

10. **项目管理 (projects)**
    - 项目列表
    - 项目创建
    - 项目设置
    - 项目删除

11. **用户管理 (users)**
    - 用户列表
    - 用户创建/编辑
    - 用户权限

12. **组管理 (groups)**
    - 用户组管理
    - 组权限配置

13. **权限管理 (permissions)**
    - 全局权限
    - 项目权限
    - 权限模板

14. **设置 (settings)**
    - 系统设置
    - 项目设置
    - 各种配置选项

15. **系统管理 (system)**
    - 系统信息
    - 系统维护
    - 系统配置

16. **市场 (marketplace)**
    - 插件市场
    - 插件安装
    - 版本管理

17. **Web API (web-api, web-api-v2)**
    - API 文档
    - API 测试工具

18. **Webhooks (webhooks)**
    - Webhook 配置
    - Webhook 管理

19. **后台任务 (background-tasks)**
    - 任务列表
    - 任务状态
    - 任务管理

20. **审计日志 (audit-logs)**
    - 审计日志查看
    - 日志过滤

### 3.2 共享库模块

#### 3.2.1 shared 库 (libs/shared)

跨应用共享的通用功能：

- **API 客户端**: 基础 API 调用封装
- **组件**: 通用 UI 组件
  - 可访问性组件 (a11y)
  - 徽章组件 (badges)
  - 控件组件 (controls)
  - 分面组件 (facet)
  - 国际化组件 (intl)
  - 问题组件 (issues)
  - 导航组件 (nav)
- **上下文**: React Context 提供者
- **辅助函数**: 通用工具函数
  - 路由辅助
  - URL 处理
  - 搜索功能
  - 类型检查
  - 用户工具
- **类型定义**: 共享的 TypeScript 类型

#### 3.2.2 sq-server-commons 库 (libs/sq-server-commons)

SQ-Server 专用的共享功能：

- **API 模块** (`src/api/`): 所有后端 API 的客户端封装
  - 问题 API (issues.ts)
  - 项目 API (projects.ts)
  - 用户 API (users.ts)
  - 质量门 API (quality-gates.ts)
  - 质量配置 API (quality-profiles.ts)
  - 安全热点 API (security-hotspots.ts)
  - 设置 API (settings.ts)
  - 等等...

- **查询模块** (`src/queries/`): React Query 查询定义
  - 使用 `@tanstack/react-query` 进行数据获取和缓存
  - 提供预定义的查询钩子

- **组件模块** (`src/components/`): 业务组件
  - 438+ 个组件文件
  - 涵盖各种业务场景的 UI 组件

- **设计系统** (`src/design-system/`): UI 设计系统
  - 280+ 个设计系统组件
  - 主题配置
  - 样式工具
  - **注意**: 这是遗留模块，新代码应使用 `@sonarsource/echoes-react`

- **辅助函数** (`src/helpers/`): 业务相关的工具函数
  - 111+ 个辅助函数文件
  - 业务逻辑封装

- **类型定义** (`src/types/`): SQ-Server 专用的类型定义
  - 47+ 个类型定义文件

- **上下文** (`src/context/`): React Context
  - AppStateContext: 应用状态
  - CurrentUserContext: 当前用户
  - AvailableFeaturesContext: 可用功能
  - ComponentContext: 组件上下文
  - 等等...

## 4. 代码逻辑

### 4.1 应用启动流程

应用启动流程在 `apps/sq-server/src/main/js/app/index.ts` 中定义：

```typescript
1. 初始化应用变量 (initAppVariables)
2. 安装 Web 分析处理器 (installWebAnalyticsHandler)
3. 安装扩展处理器 (installExtensionsHandler)
4. 初始化 Mock API (initMockApi)
5. 获取全局导航 (getGlobalNavigation) - 仅主应用
6. 并行加载：
   - 本地化包 (loadL10nBundle)
   - 当前用户 (getCurrentUser)
   - 可用功能 (getAvailableFeatures)
   - 架构选项 (getValue)
7. 启动 React 应用 (startReactApp)
```

### 4.2 路由系统

使用 **React Router DOM v6** 进行路由管理：

- **路由配置**: 每个功能模块都有自己的 `routes.tsx` 文件
- **路由注册**: 在 `startReactApp.tsx` 中统一注册所有路由
- **路由结构**:
  - 全局路由: `/issues`, `/projects`, `/quality-gates` 等
  - 项目路由: `/project/:projectKey/issues`, `/project/:projectKey/overview` 等
  - 管理路由: `/admin/*`, `/project/:projectKey/admin/*` 等

### 4.3 数据获取模式

采用 **React Query** 进行数据管理：

1. **API 层**: `libs/sq-server-commons/src/api/` 定义 API 调用函数
2. **查询层**: `libs/sq-server-commons/src/queries/` 定义 React Query 查询
3. **组件层**: 组件中使用 `useQuery`、`useMutation` 等钩子

**示例流程**:
```
组件 → useQuery(查询键) → React Query → API 函数 → Axios → 后端 API
```

### 4.4 状态管理

采用**混合状态管理**策略：

1. **服务端状态**: 使用 React Query 管理
   - 自动缓存
   - 后台刷新
   - 乐观更新

2. **客户端状态**: 使用 React Context + useState
   - 应用状态: `AppStateContext`
   - 用户状态: `CurrentUserContext`
   - 功能标志: `AvailableFeaturesContext`

3. **表单状态**: 使用 Formik
   - 表单验证
   - 表单提交
   - 错误处理

### 4.5 组件架构

#### 组件分类

1. **容器组件 (Container Components)**
   - `AdminContainer`: 管理页面容器
   - `ComponentContainer`: 组件页面容器
   - `GlobalContainer`: 全局页面容器
   - `ProjectAdminContainer`: 项目管理容器

2. **页面组件 (Page Components)**
   - 各功能模块的主页面组件
   - 如 `IssuesApp`, `ProjectsApp` 等

3. **展示组件 (Presentational Components)**
   - 可复用的 UI 组件
   - 位于 `libs/sq-server-commons/src/components/`

4. **设计系统组件 (Design System Components)**
   - 基础 UI 组件
   - 位于 `libs/sq-server-commons/src/design-system/components/`
   - 或使用 `@sonarsource/echoes-react`

### 4.6 样式系统

采用**多层次的样式方案**：

1. **设计系统**: `@sonarsource/echoes-react` (新)
2. **遗留设计系统**: `libs/sq-server-commons/src/design-system/` (逐步淘汰)
3. **Tailwind CSS**: 实用类样式
4. **Emotion**: CSS-in-JS 样式
5. **twin.macro**: Tailwind + Emotion 集成

### 4.7 国际化 (i18n)

使用 **react-intl** 进行国际化：

- **翻译文件**: `libs/sq-server-commons/src/l10n/default.ts`
- **翻译加载**: `loadL10nBundle()` 函数
- **使用方式**: `translate()` 函数或 `<FormattedMessage />` 组件

## 5. 组件工具

### 5.1 构建工具

#### Vite 配置
- **开发服务器**: 端口 3000（可配置）
- **代理配置**: 代理 `/api` 和 `/static` 到后端服务器
- **代码分割**: 手动配置的代码块分割策略
  - vendor: React 相关
  - echoes: 设计系统
  - datefns: 日期库
  - lodash: 工具库
  - highlightjs: 代码高亮

#### 构建输出
- **输出目录**: `apps/sq-server/build/webapp/`
- **资源文件**: 按类型组织（js/, css/, 图片等）
- **许可证文件**: `vendor.LICENSE.txt`

### 5.2 开发工具

#### Nx 工作区
- **项目管理**: 使用 `project.json` 定义项目配置
- **任务执行**: `nx run <project>:<target>`
- **依赖图**: 可视化项目依赖关系
- **缓存**: 构建和测试结果缓存

#### 代码质量工具
- **ESLint**: 代码检查
  - 本地规则: `eslint-local-rules/`
  - 自定义规则用于强制执行代码规范
- **Prettier**: 代码格式化
- **TypeScript**: 类型检查

### 5.3 测试工具

#### Jest 配置
- **测试环境**: jsdom（浏览器环境模拟）
- **测试文件**: `**/__tests__/**/*.{test,spec}.{ts,tsx}`
- **覆盖率**: 使用 nyc 生成覆盖率报告
- **Mock**: MSW (Mock Service Worker) 用于 API Mock

#### 测试工具库
- **@testing-library/react**: React 组件测试
- **@testing-library/jest-dom**: DOM 断言
- **@testing-library/user-event**: 用户交互模拟
- **jest-axe**: 可访问性测试

### 5.4 其他工具

#### 组件扫描工具 (`tools/scan-components/`)
- 扫描项目中的组件使用情况
- 生成组件映射

#### Nx 自动化工具 (`tools/nx-automation/`)
- 代码生成器
- 自动化脚本

## 6. 关键设计模式

### 6.1 依赖注入模式

通过 **路径别名** 实现依赖注入：

```typescript
// tsconfig.base.json
"paths": {
  "~shared/*": ["libs/shared/src/*"],
  "~sq-server-commons/*": ["libs/sq-server-commons/src/*"],
  "~design-system": ["libs/sq-server-commons/src/design-system/index.ts"]
}
```

### 6.2 插件扩展模式

通过 **addons** 机制实现功能扩展：

```typescript
// libs/sq-server-addons/src/index.ts
export const addons = {
  branches: ... // 可选的分支功能
};
```

### 6.3 懒加载模式

使用 **React.lazy** 和自定义 `lazyLoadComponent` 实现代码分割：

```typescript
const IssuesApp = lazyLoadComponent(() => import('./components/IssuesApp'));
```

### 6.4 适配器模式

通过 **adapters** 层封装 API 调用：

```typescript
// ~adapters/helpers/request
// 统一的请求处理层
```

### 6.5 上下文模式

使用 **React Context** 提供全局状态：

- `AppStateContext`: 应用状态
- `CurrentUserContext`: 当前用户
- `AvailableFeaturesContext`: 功能标志

## 7. 开发工作流

### 7.1 开发命令

```bash
# 启动开发服务器（连接到本地 SonarQube 实例）
yarn start-sqs

# 启动开发服务器（使用 Mock API）
yarn start-sqs-w-mocks

# 构建项目
yarn build

# 运行测试
yarn test

# 代码检查
yarn lint

# 类型检查
yarn ts-check

# 格式化代码
yarn format

# 验证（运行所有检查）
yarn validate
```

### 7.2 项目结构约定

1. **功能模块**: 每个功能在 `apps/sq-server/src/main/js/apps/` 下有独立目录
2. **路由文件**: 每个模块有 `routes.tsx` 定义路由
3. **组件目录**: `components/` 存放页面组件
4. **工具函数**: `utils.ts` 存放模块相关的工具函数
5. **测试文件**: `__tests__/` 目录存放测试文件

### 7.3 代码规范

1. **组件命名**: PascalCase
2. **文件命名**: 与组件名一致
3. **函数命名**: camelCase
4. **常量命名**: UPPER_SNAKE_CASE
5. **类型定义**: 使用 TypeScript 接口和类型
6. **导入顺序**:
   - React 相关
   - 第三方库
   - 内部库（~shared, ~sq-server-commons）
   - 相对路径导入

## 8. 部署和构建

### 8.1 构建流程

1. **依赖安装**: `yarn install`
2. **类型检查**: `yarn ts-check`
3. **代码检查**: `yarn lint`
4. **测试**: `yarn test`
5. **构建**: `yarn build`
6. **输出**: `apps/sq-server/build/webapp/`

### 8.2 构建优化

- **代码分割**: 手动配置的代码块
- **Tree Shaking**: 自动移除未使用代码
- **压缩**: 生产环境自动压缩
- **Source Maps**: 生产环境生成 source maps
- **浏览器兼容**: 使用 legacy 插件支持旧浏览器

### 8.3 与后端集成

构建后的前端文件需要集成到 SonarQube 后端：

```bash
# 在后端项目中指定前端构建路径
WEBAPP_BUILD_PATH=/path/to/sonarqube-webapp/apps/sq-server/build/webapp ./gradlew build
```

## 9. 总结

### 9.1 架构特点

1. **模块化**: 清晰的模块划分，便于维护和扩展
2. **可复用**: 通过共享库实现代码复用
3. **类型安全**: 全面的 TypeScript 类型定义
4. **性能优化**: 代码分割、懒加载、缓存策略
5. **开发体验**: 热重载、Mock API、完善的工具链

### 9.2 技术亮点

1. **现代化技术栈**: React 18 + TypeScript + Vite
2. **状态管理**: React Query 用于服务端状态
3. **设计系统**: 逐步迁移到 Echoes 设计系统
4. **国际化**: 完整的 i18n 支持
5. **可访问性**: 关注 a11y 最佳实践
6. **测试**: 完善的测试基础设施

### 9.3 未来方向

1. **设计系统迁移**: 从遗留设计系统迁移到 Echoes
2. **代码现代化**: 逐步重构遗留代码
3. **性能优化**: 持续优化构建和运行时性能
4. **类型安全**: 增强类型定义覆盖
5. **测试覆盖**: 提高测试覆盖率

---

**文档生成时间**: 2025年1月
**项目版本**: 基于当前代码库分析
